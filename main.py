import os
from fastapi import FastAPI, Request
from fastapi.responses import PlainTextResponse
from twilio.twiml.voice_response import VoiceResponse
import openai
from elevenlabs.client import ElevenLabs
from elevenlabs import VoiceSettings

app = FastAPI()

# ===== Milj√∂variabler =====
openai.api_key = os.getenv("OPENAI_API_KEY")
eleven_client = ElevenLabs(api_key=os.getenv("ELEVENLABS_API_KEY"))
voice_id = os.getenv("VOICE_ID")

# ===== Prompt =====
base_prompt = """
Du √§r en AI-assistent som heter Sanna och jobbar f√∂r {{f√∂retagsnamn}}. Du ringer villa√§gare f√∂r att h√∂ra om de funderar p√• {{tj√§nst}}.
Efter presentationen inled g√§rna med att fr√•ga om kunden k√§nner till f√∂retaget du ringer ifr√•n. Inv√§nta sedan svar.
Skriv som man pratar, inte som man skriver. Upprepa inte kundens namn i varje mening.

Du ska l√•ta som en trevlig m√§nniska ‚Äì tydlig, varm och avslappnad. Inte f√∂r s√§ljig, inte f√∂r stel. Prata som du skulle g√∂ra i ett riktigt samtal.
St√§ll en enkel inledande fr√•ga. F√∂lj upp naturligt beroende p√• vad kunden svarar. H√•ll dig till max 2‚Äì3 meningar per svar. Undvik l√•nga f√∂rklaringar.

Syftet √§r att ta reda p√• om kunden har ett intresse och f√∂rs√∂ka f√• till ett m√∂te med kunden. Var tydlig med att l√§get √§r helt r√§tt i tiden just nu d√• priserna och bidragen √§r helt r√§tt.

Huvudm√•let √§r att f√• kunden att f√∂rst√• att det √§r ett kostnadsfritt m√∂te och s√§ljaren som kommer kan sin sak. Hen presenterar b√•de ett pris och om det √§r l√∂nsamt f√∂r kunden. Vi prelimin√§rbokar inte m√∂ten utan det √§r viktigt att kunden f√∂rst√•r att de f√•r hem en s√§ljare till sig som g√•r igenom kalkylen och det b√§sta f√∂r just dem.

Vi skickar inte ut information utan syftet √§r att vi ska boka ett m√∂te.
Vid inbokat m√∂te ‚Äì f√∂resl√• en eftermiddag eller f√∂rmiddag, fr√•ga vad som passar kunden b√§st. Vid svar s√§g en dag och tid (max en vecka fram√•t i tiden).

Meddela att kunden kommer f√• en bokningsbekr√§ftelse p√• sms efter samtalet.
"""

@app.get("/")
def index():
    return {"message": "‚úÖ AI Call Agent k√∂r ‚Äì POST /voice"}

@app.post("/voice")
async def voice(request: Request):
    form = await request.form()
    user_input = form.get("SpeechResult", "Hej!")

    try:
        reply = openai.ChatCompletion.create(
            model="gpt-4",
            messages=[
                {"role": "system", "content": base_prompt},
                {"role": "user", "content": user_input}
            ]
        ).choices[0].message.content
    except Exception as e:
        print("üî¥ OpenAI error:", e)
        reply = "Jag √§r ledsen, n√•got gick fel."

    try:
        audio = eleven_client.generate(
            text=reply,
            voice=voice_id,
            model="eleven_multilingual_v2",
            voice_settings=VoiceSettings(stability=0.5, similarity_boost=0.8),
            stream=True
        )
        eleven_client.stream(audio)
    except Exception as e:
        print("üî¥ ElevenLabs error:", e)

    vr = VoiceResponse()
    vr.say("Tack f√∂r samtalet, hej d√•.")
    return PlainTextResponse(str(vr), media_type="application/xml")
